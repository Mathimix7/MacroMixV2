def startFlask():
    from flask import Flask, redirect, request, url_for
    import os
    import json
    import requests
    import socket
    import webbrowser
    import sys
    path = os.path.split(sys.argv[0])[0]
    print(path)
    webbrowser.open('http://127.0.0.1:8000')
    app = Flask(__name__, static_url_path='/static')
    app.secret_key = os.urandom(24)

    def discover():
        """ Locate Hue Bridge IP using UPnP SSDP search. Discovery will return
        when bridge is found or 3 seconds after last device response. Returns IP
        address or None."""
        HEADER = b"""M-SEARCH * HTTP/1.1\r
        HOST: 239.255.255.250:1900\r
        MAN: "ssdp:discover"\r
        ST: ssdp:all\r
        MX: 3\r
        \r
        """
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.sendto(HEADER, ('239.255.255.250',1900))    #UPnP Multicast
        s.settimeout(3)

        IP = None
        while IP == None:
            data, addr = s.recvfrom(1024)
            lines = data.split(b'\r\n')
            for l in lines:
                tokens = l.split(b' ')
                if tokens[0] == b'SERVER:':
                    product = tokens[3].split(b'/')
                    if product[0] == b'IpBridge':
                        IP = str(addr[0])
                        break
        s.close()
        return IP

    @app.route("/")
    def home():
        return """<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MacroMix Hue Bridge</title>
    </head>
    <body>
        <style>
            body{
                background: #333333;
            }
            h3{
                text-align: center;
                font-size: 30px;
                color: #c8c8c8
            }
            h1{
                margin-top: -20px;
                text-align: center;
                font-size: 50px;
                color: #e6e6e6
            }
            img{
                width: 20%;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            .container { 
                height: 200px;
                position: relative;
            }
            .button {
                width: 250px;
                height: 50px;
                position: absolute;
                left: 50%;
                top: 50px;
                background-color:#646464;
                color: #fff;
                border:none; 
                font-size: 25px;
                border-radius:5px; 
                transition: 0.5s;
                transform: translate(-50%, -50%);
                cursor: pointer;
            }
            .button:hover{
                background-color:#4242f8;
            }
            .lds-dual-ring {
                display: inline-block;
                width: 80px;
                height: 80px;
                position: absolute;
                left: 50%;
                top: 50px;
                transform: translate(-50%, -50%);
            }
            .lds-dual-ring:after {
                content: " ";
                display: block;
                width: 64px;
                height: 64px;
                margin: 8px;
                border-radius: 50%;
                border: 6px solid #fff;
                border-color: #fff transparent #fff transparent;
                animation: lds-dual-ring 1.2s linear infinite;
            }
            @keyframes lds-dual-ring {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            div#loading {
                display: none;
            }

        </style>
        <div id="content">
            <h3>Philips Hue x MacroMix</h3>
            <h1>Add Bridge</h1>
            <img src="/static/hueBridge.png"/>
            <div class="container">
                <a href="/discover">
                    <button class="button" onclick=startLoading()>Discover Bridges</button>
                </a> 
            </div>
        </div>
        <div id="loading">
            <h3>Philips Hue x MacroMix</h3>
            <h1>Searching for Bridges...</h1>
            <img src="/static/hueBridge.png"/>
            <div class="container">
                <div class="lds-dual-ring"></div>
            </div>
        </div>
        <script>
            function startLoading() {
                var x = document.getElementById("content")
                x.style.display = "none"
                var x = document.getElementById("loading")
                x.style.display = "block"
            }
        </script>
</body>
</html>"""
    
    @app.route("/discover")
    def bridges():
        try:
            ip = requests.get("https://discovery.meethue.com/").json()[0]["internalipaddress"]
        except:
            try:
                ip = discover()
            except:
                ip = None
        if ip != None:
            print(ip)
            return redirect(f"/setup?ip={ip}")

        return """
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>MacroMix Hue Bridge</title>
            </head>
            <body>
                <style>
                    body{
                        background: #333333;
                    }
                    h3{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8
                    }
                    h1{
                        margin-top: -20px;
                        text-align: center;
                        font-size: 50px;
                        color: #e6e6e6
                    }
                    img{
                        width: 20%;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                    }
                    .container { 
                        height: 200px;
                        position: relative;
                    }
                    .button {
                        width: 250px;
                        height: 50px;
                        position: absolute;
                        left: 50%;
                        top: 120px;
                        background-color:#646464;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        border-radius:5px; 
                        transition: 0.5s;
                        cursor: pointer;
                        transform: translate(-50%, -50%);
                    }
                    .button:hover{
                        background-color:#4242f8;
                    }
                    .lds-dual-ring {
                        display: inline-block;
                        width: 80px;
                        height: 80px;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        transform: translate(-50%, -50%);
                    }
                    .lds-dual-ring:after {
                        content: " ";
                        display: block;
                        width: 64px;
                        height: 64px;
                        margin: 8px;
                        border-radius: 50%;
                        border: 6px solid #fff;
                        border-color: #fff transparent #fff transparent;
                        animation: lds-dual-ring 1.2s linear infinite;
                    }
                    @keyframes lds-dual-ring {
                        0% {
                            transform: rotate(0deg);
                        }
                        100% {
                            transform: rotate(360deg);
                        }
                    }
                    div#loading {
                        display: none;
                    }
                    .form{
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        transform: translate(-50%, -50%);
                    }
                    .h3form{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8;
                        margin-top: 10px;
                    }
                    .formInput{
                        width: 200px;
                        height: 10px;
                        background-color: #646464;
                        color: white;
                        padding: 14px 20px;
                        margin: 8px 0;
                        outline: none;
                        border-radius: 4px;
                        cursor: pointer;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        font-size: 25px;
                        border: 2px solid #8e9292;
                        transform: translate(-50%, -50%);
                        text-align: center; 
                    }
                    .formInput::placeholder {
                        text-align: center; 
                    }
                    .input-field:focus{
                        border-color: #8e9292;
                        box-shadow: 0 4px 4px rgba(229, 103, 23, 0.075) inset, 0 0 8px#8e9292;
                        outline: 0 none;
                    }

                </style>
                <div id="content">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>Not Found</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <h3 class="h3form">Starting manual configuration. Please enter Hue Bridge IP manually.</h3>
                        <form action="/discoverManual">
                            <input class="formInput" type="text" id="ip" name="ip" placeholder="Hue Bridge IP"><br>
                            
                            <input type="submit" value="Discover Manually" class="button" onclick=startLoading()></button>
                        </a> 
                    </div>
                </div>
                <div id="loading">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>Searching for Bridges...</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <div class="lds-dual-ring"></div>
                    </div>
                </div>
                <script>
                    function startLoading() {
                        var x = document.getElementById("content")
                        x.style.display = "none"
                        var x = document.getElementById("loading")
                        x.style.display = "block"
                    }
                </script>
            </body>
        </html>"""

    @app.route("/discoverManual")
    def manualDiscover():
        ip = request.args.get("ip")
        print(ip)
        try:
            a = requests.get(url=f"http://{ip}/api/newdeveloper").json()
            print(a)
            if a == [{"error":{"type":1,"address":"/","description":"unauthorized user"}}]:
                return redirect(f"/setup?ip={ip}")
            else:
                raise
        except:
            return """
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>MacroMix Hue Bridge</title>
            </head>
            <body>
                <style>
                    body{
                        background: #333333;
                    }
                    h3{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8
                    }
                    h1{
                        margin-top: -20px;
                        text-align: center;
                        font-size: 50px;
                        color: #e6e6e6
                    }
                    img{
                        width: 20%;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                    }
                    .container { 
                        height: 200px;
                        position: relative;
                    }
                    .button {
                        width: 250px;
                        height: 50px;
                        position: absolute;
                        left: 50%;
                        top: 120px;
                        background-color:#646464;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        border-radius:5px; 
                        transition: 0.5s;
                        cursor: pointer;
                        transform: translate(-50%, -50%);
                    }
                    .button:hover{
                        background-color:#4242f8;
                    }
                    .lds-dual-ring {
                        display: inline-block;
                        width: 80px;
                        height: 80px;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        transform: translate(-50%, -50%);
                    }
                    .lds-dual-ring:after {
                        content: " ";
                        display: block;
                        width: 64px;
                        height: 64px;
                        margin: 8px;
                        border-radius: 50%;
                        border: 6px solid #fff;
                        border-color: #fff transparent #fff transparent;
                        animation: lds-dual-ring 1.2s linear infinite;
                    }
                    @keyframes lds-dual-ring {
                        0% {
                            transform: rotate(0deg);
                        }
                        100% {
                            transform: rotate(360deg);
                        }
                    }
                    div#loading {
                        display: none;
                    }
                    .form{
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        transform: translate(-50%, -50%);
                    }
                    .h3form{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8;
                        margin-top: 10px;
                    }
                    .formInput{
                        width: 200px;
                        height: 10px;
                        background-color: #646464;
                        color: white;
                        padding: 14px 20px;
                        margin: 8px 0;
                        outline: none;
                        border-radius: 4px;
                        cursor: pointer;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        font-size: 25px;
                        border: 2px solid #8e9292;
                        transform: translate(-50%, -50%);
                        text-align: center; 
                    }
                    .formInput::placeholder {
                        text-align: center; 
                    }
                    .input-field:focus{
                        border-color: #8e9292;
                        box-shadow: 0 4px 4px rgba(229, 103, 23, 0.075) inset, 0 0 8px#8e9292;
                        outline: 0 none;
                    }

                </style>
                <div id="content">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>Not Found</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <h3 class="h3form">Starting manual configuration. Please enter Hue Bridge IP manually.</h3>
                        <form action="/discoverManual">
                            <input class="formInput" type="text" id="ip" name="ip" placeholder="Hue Bridge IP"><br>
                            
                            <input type="submit" value="Discover Manually" class="button" onclick=startLoading()></button>
                        </a> 
                    </div>
                </div>
                <div id="loading">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>Searching for Bridges...</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <div class="lds-dual-ring"></div>
                    </div>
                </div>
                <script>
                    function startLoading() {
                        var x = document.getElementById("content")
                        x.style.display = "none"
                        var x = document.getElementById("loading")
                        x.style.display = "block"
                    }
                </script>
            </body>
        </html>"""

    @app.route("/setup")
    def setup():
        return """
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MacroMix Hue Bridge</title>
        </head>
        <body>
            <style>
                body{
                    background: #333333;
                }
                h3{
                    text-align: center;
                    font-size: 30px;
                    color: #c8c8c8
                }
                h1{
                    margin-top: -20px;
                    text-align: center;
                    font-size: 50px;
                    color: #e6e6e6
                }
                img{
                    width: 20%;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;
                }
                .container { 
                    height: 200px;
                    position: relative;
                }
                .button {
                    width: 250px;
                    height: 50px;
                    position: absolute;
                    left: 50%;
                    top: 120px;
                    background-color:#646464;
                    color: #fff;
                    border:none; 
                    font-size: 25px;
                    border-radius:5px; 
                    transition: 0.5s;
                    cursor: pointer;
                    transform: translate(-50%, -50%);
                }
                .button:hover{
                    background-color:#4242f8;
                }
                .lds-dual-ring {
                    display: inline-block;
                    width: 80px;
                    height: 80px;
                    position: absolute;
                    left: 50%;
                    top: 50px;
                    transform: translate(-50%, -50%);
                }
                .lds-dual-ring:after {
                    content: " ";
                    display: block;
                    width: 64px;
                    height: 64px;
                    margin: 8px;
                    border-radius: 50%;
                    border: 6px solid #fff;
                    border-color: #fff transparent #fff transparent;
                    animation: lds-dual-ring 1.2s linear infinite;
                }
                @keyframes lds-dual-ring {
                    0% {
                        transform: rotate(0deg);
                    }
                    100% {
                        transform: rotate(360deg);
                    }
                }
                div#loading {
                    display: none;
                }
                .form{
                    position: absolute;
                    left: 50%;
                    top: 50px;
                    color: #fff;
                    border:none; 
                    font-size: 25px;
                    transform: translate(-50%, -50%);
                }
                .h3form{
                    text-align: center;
                    font-size: 30px;
                    color: #c8c8c8;
                    margin-top: 10px;
                }
                .formInput{
                    width: 200px;
                    height: 10px;
                    background-color: #646464;
                    color: white;
                    padding: 14px 20px;
                    margin: 8px 0;
                    outline: none;
                    border-radius: 4px;
                    cursor: pointer;
                    position: absolute;
                    left: 50%;
                    top: 50px;
                    font-size: 25px;
                    border: 2px solid #8e9292;
                    transform: translate(-50%, -50%);
                    text-align: center; 
                }
                .formInput::placeholder {
                    text-align: center; 
                }
                .input-field:focus{
                    border-color: #8e9292;
                    box-shadow: 0 4px 4px rgba(229, 103, 23, 0.075) inset, 0 0 8px#8e9292;
                    outline: 0 none;
                }

            </style>
            <div id="content">
                <h3>Philips Hue x MacroMix</h3>
                <h1>Bridge Found</h1>
                <img src="./static/hueBridge.png"/>
                <div class="container">
                    <h3 class="h3form">Choose a name & Press Hue Bridge button</h3>
                    <form onsubmit="return submitForm()">
                        <input class="formInput" type="text" id="name" name="name" placeholder="Name"><br>
                        <input type="submit" value="Create User" class="button" onclick=startLoading()></button>
                    </a> 
                </div>
            </div>
            <div id="loading">
                <h3>Philips Hue x MacroMix</h3>
                <h1>Creating user</h1>
                <img src="./static/hueBridge.png"/>
                <div class="container">
                    <div class="lds-dual-ring"></div>
                </div>
            </div>
            <script>
                function findGetParameter(parameterName) {
                var result = null,
                    tmp = [];
                location.search
                    .substr(1)
                    .split("&")
                    .forEach(function (item) {
                    tmp = item.split("=");
                    if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                    });
                return result;
                }
                function submitForm() {
                    var ip = findGetParameter("ip")
                    console.log(ip)
                    var name = document.getElementById("name").value
                    window.location = '/createUser?ip='+ip+'&name='+name
                    return false
                }
                function startLoading() {
                    var x = document.getElementById("content")
                    x.style.display = "none"
                    var x = document.getElementById("loading")
                    x.style.display = "block"
                }
            </script>
        </body>
        </html>"""

    @app.route("/createUser")
    def createUser():
        ip = request.args.get("ip")
        name = request.args.get("name")
        pressButtonHTML = """<!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>MacroMix Hue Bridge</title>
            </head>
            <body>
                <style>
                    body{
                        background: #333333;
                    }
                    h3{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8
                    }
                    h1{
                        margin-top: -20px;
                        text-align: center;
                        font-size: 50px;
                        color: #e6e6e6
                    }
                    img{
                        width: 20%;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                    }
                    .container { 
                        height: 200px;
                        position: relative;
                    }
                    .button {
                        width: 250px;
                        height: 50px;
                        position: absolute;
                        left: 50%;
                        top: 80px;
                        background-color:#646464;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        border-radius:5px; 
                        transition: 0.5s;
                        cursor: pointer;
                        transform: translate(-50%, -50%);
                    }
                    .button:hover{
                        background-color:#4242f8;
                    }
                    .lds-dual-ring {
                        display: inline-block;
                        width: 80px;
                        height: 80px;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        transform: translate(-50%, -50%);
                    }
                    .lds-dual-ring:after {
                        content: " ";
                        display: block;
                        width: 64px;
                        height: 64px;
                        margin: 8px;
                        border-radius: 50%;
                        border: 6px solid #fff;
                        border-color: #fff transparent #fff transparent;
                        animation: lds-dual-ring 1.2s linear infinite;
                    }
                    @keyframes lds-dual-ring {
                        0% {
                            transform: rotate(0deg);
                        }
                        100% {
                            transform: rotate(360deg);
                        }
                    }
                    div#loading {
                        display: none;
                    }
                    .form{
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        transform: translate(-50%, -50%);
                    }
                    .h3form{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8;
                        margin-top: 10px;
                    }
                    .formInput{
                        width: 200px;
                        height: 10px;
                        background-color: #646464;
                        color: white;
                        padding: 14px 20px;
                        margin: 8px 0;
                        outline: none;
                        border-radius: 4px;
                        cursor: pointer;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        font-size: 25px;
                        border: 2px solid #8e9292;
                        transform: translate(-50%, -50%);
                        text-align: center; 
                    }
                    .formInput::placeholder {
                        text-align: center; 
                    }
                    .input-field:focus{
                        border-color: #8e9292;
                        box-shadow: 0 4px 4px rgba(229, 103, 23, 0.075) inset, 0 0 8px#8e9292;
                        outline: 0 none;
                    }

                </style>
                <div id="content">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>User Creation Failed</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <h3 class="h3form">Press Hue Bridge button and retry!</h3>
                        <input type="submit" value="Retry" class="button" onclick=startLoading()></button> 
                    </div>
                </div>
                <div id="loading">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>Creating user</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <div class="lds-dual-ring"></div>
                    </div>
                </div>
                <script>
                    function findGetParameter(parameterName) {
                    var result = null,
                        tmp = [];
                    location.search
                        .substr(1)
                        .split("&")
                        .forEach(function (item) {
                        tmp = item.split("=");
                        if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                        });
                    return result;
                    }
                    function startLoading() {
                        var ip = findGetParameter("ip")
                        var name = findGetParameter("name")
                        var x = document.getElementById("content")
                        x.style.display = "none"
                        var x = document.getElementById("loading")
                        x.style.display = "block"
                        window.location = '/createUser?ip='+ip+'&name='+name
                    }
                </script>
            </body>
            </html>"""
        unexpectedErrorHTML = """<!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>MacroMix Hue Bridge</title>
            </head>
            <body>
                <style>
                    body{
                        background: #333333;
                    }
                    h3{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8
                    }
                    h1{
                        margin-top: -20px;
                        text-align: center;
                        font-size: 50px;
                        color: #e6e6e6
                    }
                    img{
                        width: 20%;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                    }
                    .container { 
                        height: 200px;
                        position: relative;
                    }
                    .button {
                        width: 250px;
                        height: 50px;
                        position: absolute;
                        left: 50%;
                        top: 80px;
                        background-color:#646464;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        border-radius:5px; 
                        transition: 0.5s;
                        cursor: pointer;
                        transform: translate(-50%, -50%);
                    }
                    #downOne{
                        top: 150px;
                    }
                    
                    .button:hover{
                        background-color:#4242f8;
                    }
                    .lds-dual-ring {
                        display: inline-block;
                        width: 80px;
                        height: 80px;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        transform: translate(-50%, -50%);
                    }
                    .lds-dual-ring:after {
                        content: " ";
                        display: block;
                        width: 64px;
                        height: 64px;
                        margin: 8px;
                        border-radius: 50%;
                        border: 6px solid #fff;
                        border-color: #fff transparent #fff transparent;
                        animation: lds-dual-ring 1.2s linear infinite;
                    }
                    @keyframes lds-dual-ring {
                        0% {
                            transform: rotate(0deg);
                        }
                        100% {
                            transform: rotate(360deg);
                        }
                    }
                    div#loading {
                        display: none;
                    }
                    .form{
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        transform: translate(-50%, -50%);
                    }
                    .h3form{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8;
                        margin-top: 10px;
                    }
                    .formInput{
                        width: 200px;
                        height: 10px;
                        background-color: #646464;
                        color: white;
                        padding: 14px 20px;
                        margin: 8px 0;
                        outline: none;
                        border-radius: 4px;
                        cursor: pointer;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        font-size: 25px;
                        border: 2px solid #8e9292;
                        transform: translate(-50%, -50%);
                        text-align: center; 
                    }
                    .formInput::placeholder {
                        text-align: center; 
                    }
                    .input-field:focus{
                        border-color: #8e9292;
                        box-shadow: 0 4px 4px rgba(229, 103, 23, 0.075) inset, 0 0 8px#8e9292;
                        outline: 0 none;
                    }

                </style>
                <div id="content">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>User Creation Failed</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <h3 class="h3form">An unexpected error has been occur and should not be retried!</h3>
                        <button type="button" class="button" onclick=reset()>Restart</button> 
                        <button type="button" class="button" id="downOne" onclick=stop()>Stop</button> 
                    </div>
                </div>
                <script>
                    function reset() {
                        window.location = '/'
                    }
                    function stop() {
                        window.location = '/stop?state=unsuccessful'
                    }
                </script>
            </body>
            </html>"""
        try:
            a = requests.post(url=f"http://{ip}/api", json={"devicetype":f"MacroMix#{name}"}).json()
        except:
            return unexpectedErrorHTML
        try:
            if a[0]['error']["description"] == "link button not pressed":
                return pressButtonHTML
        except:
            if a[0]["success"]:
                # OBZ0TrRW-i2lKItLgQRjsbsyt2LPIwfMAX410IbI
                userName = a[0]["success"]["username"]
                if os.path.exists(os.path.join(path,"hueBridgesUsersData.json")):
                    with open(os.path.join(path,"hueBridgesUsersData.json"), "r") as f:
                        data = json.load(f)
                else:
                    data = []
                with open(os.path.join(path,"hueBridgesUsersData.json"), "w") as f:
                    data.append({"ip": ip, "prefix": "MacroMix", "name": name, "token": userName})
                    json.dump(data, f)
                return redirect("/stop?successful")
            else:
                return unexpectedErrorHTML
        
    @app.route("/stop")
    def stop():
        with open("stop.txt", "w") as f:
            f.write("True")
        return """<!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>MacroMix Hue Bridge</title>
            </head>
            <body>
                <style>
                    body{
                        background: #333333;
                    }
                    h3{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8
                    }
                    h1{
                        margin-top: -20px;
                        text-align: center;
                        font-size: 50px;
                        color: #e6e6e6
                    }
                    img{
                        width: 20%;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                    }
                    .container { 
                        height: 200px;
                        position: relative;
                    }
                    .button {
                        width: 250px;
                        height: 50px;
                        position: absolute;
                        left: 50%;
                        top: 80px;
                        background-color:#646464;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        border-radius:5px; 
                        transition: 0.5s;
                        cursor: pointer;
                        transform: translate(-50%, -50%);
                    }
                    #downOne{
                        top: 150px;
                    }
                    
                    .button:hover{
                        background-color:#4242f8;
                    }
                    .lds-dual-ring {
                        display: inline-block;
                        width: 80px;
                        height: 80px;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        transform: translate(-50%, -50%);
                    }
                    .lds-dual-ring:after {
                        content: " ";
                        display: block;
                        width: 64px;
                        height: 64px;
                        margin: 8px;
                        border-radius: 50%;
                        border: 6px solid #fff;
                        border-color: #fff transparent #fff transparent;
                        animation: lds-dual-ring 1.2s linear infinite;
                    }
                    @keyframes lds-dual-ring {
                        0% {
                            transform: rotate(0deg);
                        }
                        100% {
                            transform: rotate(360deg);
                        }
                    }
                    div#unsuccessfully {
                        display: none;
                    }
                    .form{
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        color: #fff;
                        border:none; 
                        font-size: 25px;
                        transform: translate(-50%, -50%);
                    }
                    .h3form{
                        text-align: center;
                        font-size: 30px;
                        color: #c8c8c8;
                        margin-top: 10px;
                    }
                    .formInput{
                        width: 200px;
                        height: 10px;
                        background-color: #646464;
                        color: white;
                        padding: 14px 20px;
                        margin: 8px 0;
                        outline: none;
                        border-radius: 4px;
                        cursor: pointer;
                        position: absolute;
                        left: 50%;
                        top: 50px;
                        font-size: 25px;
                        border: 2px solid #8e9292;
                        transform: translate(-50%, -50%);
                        text-align: center; 
                    }
                    .formInput::placeholder {
                        text-align: center; 
                    }
                    .input-field:focus{
                        border-color: #8e9292;
                        box-shadow: 0 4px 4px rgba(229, 103, 23, 0.075) inset, 0 0 8px#8e9292;
                        outline: 0 none;
                    }

                </style>
                <div id="successfully">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>User created successfully</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <h3 class="h3form">Stopping server soon!</h3>
                    </div>
                </div>
                <div id="unsuccessfully">
                    <h3>Philips Hue x MacroMix</h3>
                    <h1>Thank you!</h1>
                    <img src="./static/hueBridge.png"/>
                    <div class="container">
                        <h3 class="h3form">Stopping server soon!</h3>
                    </div>
                <script>
                    function findGetParameter(parameterName) {
                    var result = null,
                        tmp = [];
                    location.search
                        .substr(1)
                        .split("&")
                        .forEach(function (item) {
                        tmp = item.split("=");
                        if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                        });
                    return result;
                    }
                    function checkForState() {
                        var state = findGetParameter("state")
                        if (state != "successfully"){
                            var x = document.getElementById("successfully")
                            x.style.display = "none"
                            var x = document.getElementById("unsuccessfully")
                            x.style.display = "block"
                        }
                    }
                    checkForState()
                </script>
            </body>
            </html>"""
    app.run(host='0.0.0.0', port=8000)

startFlask()

# if __name__ == '__main__':
#     with open("stop.txt", "w") as f:
#         f.write("False")
#     server = multiprocessing.Process(target=startFlask)
#     server.start()
#     while True:
#         with open("stop.txt", "r") as f:
#             data = f.read()
#         if data == "True":
#             time.sleep(1) # Wait until the website loads
#             break
#     server.terminate()
#     server.join()
#     print('stopping flask...')

# from save import save
# save(r"site-packages\hue-connection\flaskBridge.txt", startFlask)